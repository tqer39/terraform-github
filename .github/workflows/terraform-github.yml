---
name: Terraform - GitHub

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: terraform-github-${{ github.ref }}
  cancel-in-progress: true

env:
  AWS_ENV_NAME: portfolio

jobs:
  set-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set Matrix
        id: set-matrix
        uses: ./.github/actions/set-matrix

  terraform:
    needs: set-matrix
    if: needs.set-matrix.outputs.matrix != '["_empty"]'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        target: ${{ fromJson(needs.set-matrix.outputs.matrix) }}
    permissions:
      contents: write
      id-token: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v6

      - name: AWS Credential
        uses: ./.github/actions/aws-credential
        with:
          oidc-iam-role: arn:aws:iam::072693953877:role/portfolio-terraform-github-deploy

      - name: Generate GitHub App Token
        id: app_token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.GHA_APP_ID }}
          private-key: ${{ secrets.GHA_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - uses: ./.github/actions/terraform-plan
        with:
          working-directory: ./terraform/src/repositories/${{ matrix.target }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_APPS_TOKEN: ${{ secrets.TERRAFORM_GITHUB_TOKEN }}

      # NOTE: GitHub App では個人アカウントのリポジトリを作成することが仕様上不可能なので PAT を使用する。
      - uses: ./.github/actions/terraform-apply
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        with:
          working-directory: ./terraform/src/repositories/${{ matrix.target }}
          GITHUB_TOKEN: ${{ secrets.TERRAFORM_GITHUB_TOKEN }}

  workflow-result:
    needs: [set-matrix, terraform]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Delete "No changes" PR comments
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api "repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
            --jq '.[] | select(.body | contains("No changes. Your infrastructure matches the configuration.")) | .id' \
            | while read -r comment_id; do
                echo "Deleting comment: $comment_id"
                gh api -X DELETE "repos/${{ github.repository }}/issues/comments/$comment_id"
              done

      - name: Check workflow result
        run: |
          if [ "${{ needs.set-matrix.outputs.matrix }}" == '["_empty"]' ]; then
            echo "No repositories to process"
            exit 0
          fi
          if [ "${{ needs.terraform.result }}" == "failure" ]; then
            echo "Terraform jobs failed"
            exit 1
          fi
          echo "All jobs completed successfully"
